<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="qFs2bsqSZ8LeOYp-DHo4__pZKFNgy_CWPBy8GYQ_gXY" />













  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android,Daemon,JobService,JobScheduler,Process,Service,StartForeground," />





  <link rel="alternate" href="/blog/atom.xml" title="穿裤衩闯天下" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico?v=5.1.0" />






<meta name="description" content="项目源码：【lzan13 / VMDaemonService】我的简书：【lzan13 / Android 守护进程的实现方式】

在我们进行应用开发时，会遇到上级的各种需求，其中有一条 刚需：后台保活，更有甚者：
我要我们的应用永远活在用户的手机后台不被杀死—— 这都 TM 的扯淡

除了系统级别的应用能持续运行，所有三方程序都有被杀死的那一天！当然QQ/微信/陌陌等会好一些，因为他们已经深入">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 守护进程的实现方式">
<meta property="og:url" content="http://melove.net/2017/03/android-daemon-service-1488942411000.html">
<meta property="og:site_name" content="穿裤衩闯天下">
<meta property="og:description" content="项目源码：【lzan13 / VMDaemonService】我的简书：【lzan13 / Android 守护进程的实现方式】

在我们进行应用开发时，会遇到上级的各种需求，其中有一条 刚需：后台保活，更有甚者：
我要我们的应用永远活在用户的手机后台不被杀死—— 这都 TM 的扯淡

除了系统级别的应用能持续运行，所有三方程序都有被杀死的那一天！当然QQ/微信/陌陌等会好一些，因为他们已经深入">
<meta property="og:updated_time" content="2017-03-10T03:53:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 守护进程的实现方式">
<meta name="twitter:description" content="项目源码：【lzan13 / VMDaemonService】我的简书：【lzan13 / Android 守护进程的实现方式】

在我们进行应用开发时，会遇到上级的各种需求，其中有一条 刚需：后台保活，更有甚者：
我要我们的应用永远活在用户的手机后台不被杀死—— 这都 TM 的扯淡

除了系统级别的应用能持续运行，所有三方程序都有被杀死的那一天！当然QQ/微信/陌陌等会好一些，因为他们已经深入">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://melove.net/2017/03/android-daemon-service-1488942411000.html"/>





  <title> Android 守护进程的实现方式 | 穿裤衩闯天下 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d3596a23cae06acd72c15fd1fe2f6afd√";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/blog/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">穿裤衩闯天下</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description">慢慢来，一步一个脚印！</h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/blog/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/blog/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://melove.net/blog/2017/03/android-daemon-service-1488942411000.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="lzan13">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/blog/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="穿裤衩闯天下">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="穿裤衩闯天下" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                Android 守护进程的实现方式
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-08T11:06:51+08:00">
                2017-03-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/Develop/" itemprop="url" rel="index">
                    <span itemprop="name">Develop</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>项目源码：【<a href="https://github.com/lzan13" target="_blank" rel="external">lzan13</a> / <a href="https://github.com/lzan13/VMDaemonServices" target="_blank" rel="external">VMDaemonService</a>】<br>我的简书：【<a href="http://jianshu.com/u/f53bcbbc7c3e" target="_blank" rel="external">lzan13</a> / <a href="http://www.jianshu.com/p/b16631a2fe3c" target="_blank" rel="external">Android 守护进程的实现方式</a>】</p>
</blockquote>
<p>在我们进行应用开发时，会遇到上级的各种需求，其中有一条 刚需：<code>后台保活</code>，更有甚者：</p>
<blockquote class="blockquote-center">我要我们的应用永远活在用户的手机后台不被杀死<br>—— 这都 TM 的扯淡</blockquote>

<p>除了系统级别的应用能持续运行，所有三方程序都有被杀死的那一天！当然<code>QQ/微信/陌陌</code>等会好一些，因为他们已经深入设备的<code>心</code>；<br>我们能做的只是通过各种手段尽量让我们的程序在后台运行的时间长一些，或者在被干掉的时候，能够重新站起来，而且这个也不是每次都有效的，也是不能在所有的设备的上都有效的；要做到后台进程保活，我们需要做到两方便：</p>
<ol>
<li>提高进程优先级，降低被回收或杀死概率</li>
<li>在进程被干掉后，进行拉起</li>
</ol>
<p>要实现实现上边所说，通过下边几点来实现，首先我们需要了解下进程的优先级划分：</p>
<h3 id="进程的优先级"><a href="#进程的优先级" class="headerlink" title="#进程的优先级"></a>#进程的优先级</h3><p><code>Process Importance</code>记录在<code>ActivityManager.java</code>类中:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Path：SDK/sources/android-25/android/app/ActivityManager#RunningAppProcessInfo.java</div><div class="line"> * </div><div class="line"> * 这个进程正在运行前台UI，也就是说，它是当前在屏幕顶部的东西，用户正在进行交互的而进程</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_FOREGROUND = <span class="number">100</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 此进程正在运行前台服务，即使用户不是在应用中时也执行音乐播放，这一般表示该进程正在做用户积极关心的事情</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_FOREGROUND_SERVICE = <span class="number">125</span>;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * 这个过程不是用户的直接意识到，但在某种程度上是他们可以察觉的。</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_PERCEPTIBLE = <span class="number">130</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 此进程正在运行前台UI，但设备处于睡眠状态，因此用户不可见，意思是用户意识不到的进程，因为他们看不到或与它交互，</div><div class="line"> * 但它是相当重要，因为用户解锁设备时期望的返回到这个进程</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_TOP_SLEEPING = <span class="number">150</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 进程在后台，但我们不能恢复它的状态，所以我们想尽量避免杀死它，不然这个而进程就丢了</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_CANT_SAVE_STATE = <span class="number">170</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 此进程正在运行某些对用户主动可见的内容，但不是直接显示在UI，</div><div class="line"> * 这可能运行在当前前台之后的窗口（因此暂停并且其状态被保存，不与用户交互，但在某种程度上对他们可见）;</div><div class="line"> * 也可能在系统的控制下运行其他服务，</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_VISIBLE = <span class="number">200</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 服务进程，此进程包含在后台保持运行的服务，这些后台服务用户察觉不到，是无感知的，所以它们可以由系统相对自由地杀死</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_SERVICE = <span class="number">300</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 后台进程</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_BACKGROUND = <span class="number">400</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 空进程，此进程没有任何正在运行的代码</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_EMPTY = <span class="number">500</span>;</div><div class="line"></div><div class="line"><span class="comment">// 此过程不存在。</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_GONE = <span class="number">1000</span>;</div></pre></td></tr></table></figure></p>
<h3 id="进程回收机制"><a href="#进程回收机制" class="headerlink" title="#进程回收机制"></a>#进程回收机制</h3><p>了解进程优先级之后，我们还需要知道一个进程回收机制的东西；这里参考<code>AngelDevil</code>在博客园上的一篇文章:</p>
<blockquote>
<p>详情参考：【<a href="http://www.cnblogs.com/angeldevil/archive/2013/05/21/3090872.html" target="_blank" rel="external">Android Low Memory Killer</a>】</p>
</blockquote>
<p><code>Android</code>的<code>Low Memory Killer</code>基于<code>Linux</code>的<code>OOM</code>机制，在<code>Linux</code>中，内存是以页面为单位分配的，当申请页面分配时如果内存不足会通过以下流程选择bad进程来杀掉从而释放内存：</p>
<blockquote>
<p>alloc_pages -&gt; out_of_memory() -&gt; select_bad_process() -&gt; badness()</p>
</blockquote>
<p>在<code>Low Memory Killer</code>中通过进程的<code>oom_adj</code>与占用内存的大小决定要杀死的进程，<code>oom_adj</code>越小越不容易被杀死；<br><code>Low Memory Killer Driver</code>在用户空间指定了一组内存临界值及与之一一对应的一组<code>oom_adj</code>值，当系统剩余内存位于内存临界值中的一个范围内时，如果一个进程的<code>oom_adj</code>值大于或等于这个临界值对应的<code>oom_adj</code>值就会被杀掉。</p>
<p>下边是表示<code>Process State</code>(即老版本里的<code>OOM_ADJ</code>)数值对照表，数值越大，重要性越低，在新版SDK中已经在<code>android</code>层去除了小于0的进程状态<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Path：SDK/sources/android-25/android/app/ActivityManager#RunningAppProcessInfo.java </span></div><div class="line"><span class="comment">// 进程不存在。 </span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_NONEXISTENT = -<span class="number">1</span>;</div><div class="line"><span class="comment">// 进程是一个持久的系统进程，一般指当前 UI 进程</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_PERSISTENT = <span class="number">0</span>;</div><div class="line"><span class="comment">// 进程是一个持久的系统进程，正在做和 UI 相关的操作，但不直接显示</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_PERSISTENT_UI = <span class="number">1</span>;</div><div class="line"><span class="comment">// 进程正在托管当前的顶级活动。请注意，这涵盖了用户可见的所有活动。 </span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_TOP = <span class="number">2</span>;</div><div class="line"><span class="comment">// 进程由于系统绑定而托管前台服务。</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_BOUND_FOREGROUND_SERVICE = <span class="number">3</span>;</div><div class="line"><span class="comment">// 进程正在托管前台服务。</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_FOREGROUND_SERVICE = <span class="number">4</span>;</div><div class="line"><span class="comment">// 与&#123;@link #PROCESS_STATE_TOP&#125;相同，但设备处于睡眠状态。 </span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_TOP_SLEEPING = <span class="number">5</span>;</div><div class="line"><span class="comment">// 进程对用户很重要，是他们知道的东西</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_IMPORTANT_FOREGROUND = <span class="number">6</span>;</div><div class="line"><span class="comment">// 进程对用户很重要，但不是他们知道的</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_IMPORTANT_BACKGROUND = <span class="number">7</span>;</div><div class="line"><span class="comment">// 进程在后台运行备份/恢复操作</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_BACKUP = <span class="number">8</span>;</div><div class="line"><span class="comment">// 进程在后台，但我们不能恢复它的状态，所以我们想尽量避免杀死它，不然这个而进程就丢了</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_HEAVY_WEIGHT = <span class="number">9</span>;</div><div class="line"><span class="comment">// 进程在后台运行一个服务，与oom_adj不同，此级别用于正常运行在后台状态和执行操作状态。 </span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_SERVICE = <span class="number">10</span>;</div><div class="line"><span class="comment">// 进程在后台运行一个接收器，注意，从oom_adj接收器的角度来看，在较高的前台级运行，但是对于我们的优先级，这不是必需的，并且将它们置于服务之下意味着当它们接收广播时，一些进程状态中的更少的改变。 </span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_RECEIVER = <span class="number">11</span>;</div><div class="line"><span class="comment">// 进程在后台，但主持家庭活动</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_HOME = <span class="number">12</span>;</div><div class="line"><span class="comment">// 进程在后台，但托管最后显示的活动</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_LAST_ACTIVITY = <span class="number">13</span>;</div><div class="line"><span class="comment">// 进程正在缓存以供以后使用，并包含活动</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_CACHED_ACTIVITY = <span class="number">14</span>;</div><div class="line"><span class="comment">// 进程正在缓存供以后使用，并且是包含活动的另一个缓存进程的客户端</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_CACHED_ACTIVITY_CLIENT = <span class="number">15</span>;</div><div class="line"><span class="comment">// 进程正在缓存以供以后使用，并且为空</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_CACHED_EMPTY = <span class="number">16</span>;</div></pre></td></tr></table></figure></p>
<p><code>Process State</code>（即老版本的<code>OOM_ADJ</code>）与<code>Process Importance</code>对应关系，这个方法也是在<code>ActivityManager.java</code>类中，有了这个关系，就知道可以知道我们的应用处于哪个级别，对于我们后边优化有个很好地参考<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** </span></div><div class="line"> * Path：SDK/sources/android-25/android/app/ActivityManager#RunningAppProcessInfo.java</div><div class="line"> *</div><div class="line"> * 通过这个方法，将Linux底层的 OOM_ADJ级别码和 android 层面的进程重要程度联系了起来</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">procStateToImportance</span><span class="params">(<span class="keyword">int</span> procState)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (procState == PROCESS_STATE_NONEXISTENT) &#123;</div><div class="line">        <span class="keyword">return</span> IMPORTANCE_GONE;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_HOME) &#123;</div><div class="line">        <span class="keyword">return</span> IMPORTANCE_BACKGROUND;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_SERVICE) &#123;</div><div class="line">        <span class="keyword">return</span> IMPORTANCE_SERVICE;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt; PROCESS_STATE_HEAVY_WEIGHT) &#123;</div><div class="line">        <span class="keyword">return</span> IMPORTANCE_CANT_SAVE_STATE;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_IMPORTANT_BACKGROUND) &#123;</div><div class="line">        <span class="keyword">return</span> IMPORTANCE_PERCEPTIBLE;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_IMPORTANT_FOREGROUND) &#123;</div><div class="line">        <span class="keyword">return</span> IMPORTANCE_VISIBLE;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_TOP_SLEEPING) &#123;</div><div class="line">        <span class="keyword">return</span> IMPORTANCE_TOP_SLEEPING;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_FOREGROUND_SERVICE) &#123;</div><div class="line">        <span class="keyword">return</span> IMPORTANCE_FOREGROUND_SERVICE;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> IMPORTANCE_FOREGROUND;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>一般情况下，设备端进程被干掉有一下几种情况</p>
<table>
<thead>
<tr>
<th>进程结束场景</th>
<th>结束方式</th>
<th>影响范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>Android 系统自身内存回收机制</td>
<td>Low Memory Killer</td>
<td>Process State 数值从大到小</td>
</tr>
<tr>
<td>第三方管理程序清理进程 无 Root 权限</td>
<td>killBackgroundProcess</td>
<td>Process State 数值大于6进程</td>
</tr>
<tr>
<td>第三方管理程序清理进程 有 Root 权限</td>
<td>force-stop or Kill</td>
<td>除当前前台进程外所有非系统进程</td>
</tr>
<tr>
<td>Rom 清除进程（用户手动清理）</td>
<td>force-stop or Kill</td>
<td>所有非系统进程</td>
</tr>
<tr>
<td>用户手动强制结束</td>
<td>force-stop</td>
<td>第三方应用以及非 System 进程</td>
</tr>
</tbody>
</table>
<p>由以上分析，我们可以可以总结出，如果想提高我们应用后台运行时间，就需要提高当前应用进程优先级，来减少被杀死的概率</p>
<h3 id="守护进程的实现"><a href="#守护进程的实现" class="headerlink" title="#守护进程的实现"></a>#守护进程的实现</h3><p>分析了那么多，现在对Android自身后台进程管理，以及进程的回收也有了一个大致的了解，后边我们要做的就是想尽一切办法去提高应用进程优先级，降低进程被杀的概率；或者是在被杀死后能够重新启动后台守护进程</p>
<h4 id="1-模拟前台进程"><a href="#1-模拟前台进程" class="headerlink" title="#1.模拟前台进程"></a>#1.模拟前台进程</h4><p>第一种方式就是利用系统漏洞，使用<code>startForeground()</code>将当前进程伪装成前台进程，将进程优先级提高到最高(这里所说的最高是服务所能达到的最高，即1);</p>
<p>这种方式在<code>7.x</code>之前都是很好用的，QQ、微信、IReader、Keep 等好多应用都是用的这种方式实现；因为在7.x 以后的设备上，这种伪装前台进程的方式也会显示出来通知栏提醒，这个是取消不掉的，虽然<code>Google</code>现在还没有对这种方式加以限制，不过这个已经能够被用户感知到了，这种方式估计也用不了多久了</p>
<p>下边看下实现方式，这边这个<code>VMDaemonService</code>就是一个守护进程服务，其中在服务的<code>onStartCommand()</code>方法中调用<code>startForeground()</code>将服务进程设置为前台进程，当运行在 API18 以下的设备是可以直接设置，API18 以上需要实现一个内部的<code>Service</code>，这个内部类实现和外部类同样的操作，然后结束自己；当这个服务启动后就会创建一个定时器去发送广播，当我们的核心服务被干掉后，就由另外的广播接收器去接收我们守护进程发出的广播，然后唤醒我们的核心服务；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 以实现内部 Service 类的方式实现守护进程，这里是利用 android 漏洞提高当前进程优先级</div><div class="line"> *</div><div class="line"> * Created by lzan13 on 2017/3/7.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VMDaemonService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String TAG = VMDaemonService.class.getSimpleName();</div><div class="line"></div><div class="line">    <span class="comment">// 定时唤醒的时间间隔，这里为了自己测试方边设置了一分钟</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> ALARM_INTERVAL = <span class="number">1</span> * <span class="number">60</span> * <span class="number">1000</span>;</div><div class="line">    <span class="comment">// 发送唤醒广播请求码</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> WAKE_REQUEST_CODE = <span class="number">5121</span>;</div><div class="line">    <span class="comment">// 守护进程 Service ID</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DAEMON_SERVICE_ID = -<span class="number">5121</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.i(TAG, <span class="string">"VMDaemonService-&gt;onCreate"</span>);</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">        Log.i(TAG, <span class="string">"VMDaemonService-&gt;onStartCommand"</span>);</div><div class="line">        <span class="comment">// 利用 Android 漏洞提高进程优先级，</span></div><div class="line">        startForeground(DAEMON_SERVICE_ID, <span class="keyword">new</span> Notification());</div><div class="line">        <span class="comment">// 当 SDk 版本大于18时，需要通过内部 Service 类启动同样 id 的 Service</span></div><div class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">18</span>) &#123;</div><div class="line">            Intent innerIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, DaemonInnerService.class);</div><div class="line">            startService(innerIntent);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 发送唤醒广播来促使挂掉的UI进程重新启动起来</span></div><div class="line">        AlarmManager alarmManager = (AlarmManager) getSystemService(Context.ALARM_SERVICE);</div><div class="line">        Intent alarmIntent = <span class="keyword">new</span> Intent();</div><div class="line">        alarmIntent.setAction(VMWakeReceiver.DAEMON_WAKE_ACTION);</div><div class="line"></div><div class="line">        PendingIntent operation = PendingIntent.getBroadcast(<span class="keyword">this</span>, WAKE_REQUEST_CODE, alarmIntent,</div><div class="line">                PendingIntent.FLAG_UPDATE_CURRENT);</div><div class="line"></div><div class="line">        alarmManager.setInexactRepeating(AlarmManager.RTC_WAKEUP, System.currentTimeMillis(),</div><div class="line">                ALARM_INTERVAL, operation);</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 这里返回值是使用系统 Service 的机制自动重新启动，不过这种方式以下两种方式不适用：</div><div class="line">         * 1.Service 第一次被异常杀死后会在5秒内重启，第二次被杀死会在10秒内重启，第三次会在20秒内重启，一旦在短时间内 Service 被杀死达到5次，则系统不再拉起。</div><div class="line">         * 2.进程被取得 Root 权限的管理工具或系统工具通过 forestop 停止掉，无法重启。</div><div class="line">         */</div><div class="line">        <span class="keyword">return</span> START_STICKY;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> Return the communication channel to the service.</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"onBind 未实现"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.i(TAG, <span class="string">"VMDaemonService-&gt;onDestroy"</span>);</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 实现一个内部的 Service，实现让后台服务的优先级提高到前台服务，这里利用了 android 系统的漏洞，</div><div class="line">     * 不保证所有系统可用，测试在7.1.1 之前大部分系统都是可以的，不排除个别厂商优化限制</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonInnerService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">            Log.i(TAG, <span class="string">"DaemonInnerService -&gt; onCreate"</span>);</div><div class="line">            <span class="keyword">super</span>.onCreate();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">            Log.i(TAG, <span class="string">"DaemonInnerService -&gt; onStartCommand"</span>);</div><div class="line">            startForeground(DAEMON_SERVICE_ID, <span class="keyword">new</span> Notification());</div><div class="line">            stopSelf();</div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">            <span class="comment">// <span class="doctag">TODO:</span> Return the communication channel to the service.</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"onBind 未实现"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">            Log.i(TAG, <span class="string">"DaemonInnerService -&gt; onDestroy"</span>);</div><div class="line">            <span class="keyword">super</span>.onDestroy();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当我们启动这个守护进程的时候，就可以使用以下<code>adb</code>命令查看当前程序的进程情况（需要<code>adb shell</code>进去设备），<br>为了等下区分进程优先级，我启动了一个普通的后台进程，两外两个一个是我们启动的守护进程，一个是当前程序的核心进程，可以看到除了后台进程外，另外两个进程都带有<code>isForeground=true</code>的属性：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这个命令的 services 可以换成 service，这样会只显示当前，进程，不显示详细内容</span></div><div class="line"><span class="comment"># dumpsys activity services &lt;Your Package Name&gt;</span></div><div class="line">root@vbox86p:/ <span class="comment"># dumpsys activity services com.vmloft.develop.daemon           </span></div><div class="line">ACTIVITY MANAGER SERVICES (dumpsys activity services)</div><div class="line">  User 0 active services:</div><div class="line">  * ServiceRecord&#123;170fe1dd u0 com.vmloft.develop.daemon/.services.VMDaemonService&#125;</div><div class="line">    intent=&#123;cmp=com.vmloft.develop.daemon/.services.VMDaemonService&#125;</div><div class="line">    packageName=com.vmloft.develop.daemon</div><div class="line">    processName=com.vmloft.develop.daemon:daemon</div><div class="line">    baseDir=/data/app/com.vmloft.develop.daemon-1/base.apk</div><div class="line">    dataDir=/data/data/com.vmloft.develop.daemon</div><div class="line">    app=ProcessRecord&#123;173fe77f 2370:com.vmloft.develop.daemon:daemon/u0a68&#125;</div><div class="line">    isForeground=<span class="literal">true</span> foregroundId=-5121 foregroundNoti=Notification(pri=0 contentView=com.vmloft.develop.daemon/0x1090077 vibrate=null sound=null defaults=0x0 flags=0x62 color=0xff607d8b vis=PRIVATE)</div><div class="line">    createTime=-6s196ms startingBgTimeout=--</div><div class="line">    lastActivity=-6s157ms restartTime=-6s157ms createdFromFg=<span class="literal">true</span></div><div class="line">    startRequested=<span class="literal">true</span> delayedStop=<span class="literal">false</span> stopIfKilled=<span class="literal">false</span> callStart=<span class="literal">true</span> lastStartId=1</div><div class="line"></div><div class="line">  * ServiceRecord&#123;2fee4f84 u0 com.vmloft.develop.daemon/.services.VMCoreService&#125;</div><div class="line">    intent=&#123;cmp=com.vmloft.develop.daemon/.services.VMCoreService&#125;</div><div class="line">    packageName=com.vmloft.develop.daemon</div><div class="line">    processName=com.vmloft.develop.daemon</div><div class="line">    baseDir=/data/app/com.vmloft.develop.daemon-1/base.apk</div><div class="line">    dataDir=/data/data/com.vmloft.develop.daemon</div><div class="line">    app=ProcessRecord&#123;18c6a1b4 2343:com.vmloft.develop.daemon/u0a68&#125;</div><div class="line">    isForeground=<span class="literal">true</span> foregroundId=-5120 foregroundNoti=Notification(pri=0 contentView=com.vmloft.develop.daemon/0x1090077 vibrate=null sound=null defaults=0x0 flags=0x62 color=0xff607d8b vis=PRIVATE)</div><div class="line">    createTime=-28s136ms startingBgTimeout=--</div><div class="line">    lastActivity=-28s136ms restartTime=-28s136ms createdFromFg=<span class="literal">true</span></div><div class="line">    startRequested=<span class="literal">true</span> delayedStop=<span class="literal">false</span> stopIfKilled=<span class="literal">false</span> callStart=<span class="literal">true</span> lastStartId=1</div><div class="line"></div><div class="line">  * ServiceRecord&#123;2ef6909e u0 com.vmloft.develop.daemon/.services.VMBackgroundService&#125;</div><div class="line">    intent=&#123;cmp=com.vmloft.develop.daemon/.services.VMBackgroundService&#125;</div><div class="line">    packageName=com.vmloft.develop.daemon</div><div class="line">    processName=com.vmloft.develop.daemon:background</div><div class="line">    baseDir=/data/app/com.vmloft.develop.daemon-1/base.apk</div><div class="line">    dataDir=/data/data/com.vmloft.develop.daemon</div><div class="line">    app=ProcessRecord&#123;29f8734c 2388:com.vmloft.develop.daemon:background/u0a68&#125;</div><div class="line">    createTime=-3s279ms startingBgTimeout=--</div><div class="line">    lastActivity=-3s262ms restartTime=-3s262ms createdFromFg=<span class="literal">true</span></div><div class="line">    startRequested=<span class="literal">true</span> delayedStop=<span class="literal">false</span> stopIfKilled=<span class="literal">false</span> callStart=<span class="literal">true</span> lastStartId=1</div></pre></td></tr></table></figure></p>
<p>然后我们可以用下边的命令查看<code>ProcessID</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这个命令可以查看当前DProcessID（数据结果第二列），我们可以看到当前程序有两个进程</span></div><div class="line"><span class="comment"># ps | grep com.vmloft.develop.daemon</span></div><div class="line">root@vbox86p:/ <span class="comment"># ps | grep com.vmloft.develop.daemon</span></div><div class="line">u0_a68    2343  274   1012408 42188 ffffffff f74f1b45 S com.vmloft.develop.daemon</div><div class="line">u0_a68    2370  274   997012 26152 ffffffff f74f1b45 S com.vmloft.develop.daemon:daemon</div><div class="line">u0_a68    2388  274   997012 25668 ffffffff f74f1b45 S com.vmloft.develop.daemon:background</div></pre></td></tr></table></figure></p>
<p>有了<code>ProcessID</code>之后，我们可以根据这个<code>ProcessID</code>获取到当前进程的优先级状态<code>Process State</code>，对应<code>Linux</code>层的<code>oom_adj</code><br>可以看到当前核心进程的级别为<code>0</code>，因为这个表示当前程序运行在前台 UI 界面，守护进程级别为<code>1</code>，因为我们利用漏洞设置成了前台进程，虽然不可见，但是他的级别也是比较高的，仅次于前台 UI 进程，然后普通后台进程级别为<code>4</code>；当我们退到后台时，可以看到核心进程的级别变为<code>1</code>了，这就是因为我们利用<code>startForeground()</code>将进程设置成前台进程的原因，这样就降低了进程被系统回收的概率了；<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这个命令就是通过 ProcessID 输出其对应 oom_adj</span></div><div class="line"><span class="comment"># cat /proc/ProcessID/oom_adj</span></div><div class="line"><span class="comment"># 程序在前台时，查询进程级别</span></div><div class="line">root@vbox86p:/ <span class="comment"># cat /proc/2343/oom_adj                                      </span></div><div class="line">0</div><div class="line">root@vbox86p:/ <span class="comment"># cat /proc/2370/oom_adj                                        </span></div><div class="line">1</div><div class="line">root@vbox86p:/ <span class="comment"># cat /proc/2388/oom_adj                                        </span></div><div class="line">4</div><div class="line"><span class="comment"># 当程序退到后台时，再次查看进程级别</span></div><div class="line">root@vbox86p:/ <span class="comment"># cat /proc/2343/oom_adj                                      </span></div><div class="line">1</div><div class="line">root@vbox86p:/ <span class="comment"># cat /proc/2370/oom_adj                                        </span></div><div class="line">1</div><div class="line">root@vbox86p:/ <span class="comment"># cat /proc/2388/oom_adj                                        </span></div><div class="line">4</div></pre></td></tr></table></figure></p>
<p>可以看到这种方式确实能够提高进程优先级，但是在一些国产的设备上还是会被杀死的，比我我测试的时候小米点击清空最近运行的应用进程就别干掉了；当把应用加入到设备白名单里就不会被杀死了，微信就是这样，人家直接装上之后就已经在白名单里了，我们要做的就是在用户使用中引导他们将我们的程序设置进白名单，将守护进程和白名单结合起来，这样才能保证我们的应用持续或者</p>
<h4 id="2-JobScheduler机制唤醒"><a href="#2-JobScheduler机制唤醒" class="headerlink" title="#2.JobScheduler机制唤醒"></a>#2.JobScheduler机制唤醒</h4><p>Android系统在5.x以上版本提供了一个<code>JobSchedule</code>接口，系统会根据自己实现定时去调用改接口传递的进程去实现一些操作，而且这个接口在被强制停止后依然能够正常的启动；不过在一些国产设备上可能无效，比如小米；<br>下边是 JobServcie 的实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 5.x 以上使用 JobService 实现守护进程，这个守护进程要做的工作很简单，就是启动应用的核心进程</div><div class="line"> * Created by lzan13 on 2017/3/8.</div><div class="line"> */</div><div class="line"><span class="meta">@TargetApi</span>(Build.VERSION_CODES.LOLLIPOP) <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VMDaemonJobService</span> <span class="keyword">extends</span> <span class="title">JobService</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String TAG = VMDaemonJobService.class.getSimpleName();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onStartJob</span><span class="params">(JobParameters params)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onStartJob"</span>);</div><div class="line">        <span class="comment">// 这里为了掩饰直接启动核心进程，没有做其他判断操作</span></div><div class="line">        startService(<span class="keyword">new</span> Intent(getApplicationContext(), VMCoreService.class));</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onStopJob</span><span class="params">(JobParameters params)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onStopJob"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们要做的就是在需要的时候调用<code>JobSchedule</code>的<code>schedule</code>来启动任务；剩下的就不需要关心了，<code>JobSchedule</code>会帮我们做好，下边就是我这边实现的启动任务的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 5.x以上系统启用 JobScheduler API 进行实现守护进程的唤醒操作</div><div class="line"> */</div><div class="line"><span class="meta">@TargetApi</span>(Build.VERSION_CODES.LOLLIPOP) </div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startJobScheduler</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> jobId = <span class="number">1</span>;</div><div class="line">    JobInfo.Builder jobInfo = <span class="keyword">new</span> JobInfo.Builder(jobId, <span class="keyword">new</span> ComponentName(<span class="keyword">this</span>, VMDaemonJobService.class));</div><div class="line">    jobInfo.setPeriodic(<span class="number">10000</span>);</div><div class="line">    jobInfo.setPersisted(<span class="keyword">true</span>);</div><div class="line">    JobScheduler jobScheduler = (JobScheduler) getSystemService(Context.JOB_SCHEDULER_SERVICE);</div><div class="line">    jobScheduler.schedule(jobInfo.build());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="3-系统-Service-START-STICKY-机制重启"><a href="#3-系统-Service-START-STICKY-机制重启" class="headerlink" title="#3.系统 Service START_STICKY 机制重启"></a>#3.系统 Service START_STICKY 机制重启</h4><p>在实现<code>Service</code>类时，将<code>onStartCommand()</code>返回值设置为<code>START_STICKY</code>，利用系统机制在<code>Service</code>挂掉后自动拉活；不过这种方式只适合比较原生一些的系统，像小米，华为等这些定制化比较高的第三方厂商，他们都已经把这些给限制掉了；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</div><div class="line">    Log.i(TAG, <span class="string">"VMDaemonService-&gt;onStartCommand"</span>);</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 这里返回值是使用系统 Service 的机制自动重新启动，不过这种方式以下两种方式不适用：</div><div class="line">     * 1.Service 第一次被异常杀死后会在5秒内重启，第二次被杀死会在10秒内重启，第三次会在20秒内重启，一旦在短时间内 Service 被杀死达到5次，则系统不再拉起。</div><div class="line">     * 2.进程被取得 Root 权限的管理工具或系统工具通过 forestop 停止掉，无法重启。</div><div class="line">     * 3.一些定制化比较高的第三方系统也不适用</div><div class="line">     */</div><div class="line">    <span class="keyword">return</span> START_STICKY;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这种方式在以下两种情况无效：</p>
<ul>
<li><code>Service</code>第一次被异常杀死后会在<code>5</code>秒内重启，第二次被杀死会在<code>10</code>秒内重启，第三次会在<code>20</code>秒内重启，一旦在短时间内<code>Service</code>被杀死达到<code>5</code>次，这个服务就不能再次重启了；</li>
<li>进程被取得<code>Root</code>权限的管理工具或系统工具通过<code>fores-top</code>方式停止掉，无法重启;</li>
<li>一些定制化比较高的第三方系统也不适用</li>
</ul>
<h4 id="4-其他保活方式"><a href="#4-其他保活方式" class="headerlink" title="#4.其他保活方式"></a>#4.其他保活方式</h4><blockquote>
<ul>
<li>利用 Native 本地进程，这个主要使用到 jni 调用底层实现，而且在 Android 5.x 以后对这个限制也比较高，不适用了，暂时不研究</li>
<li>集成第三方SDK互相唤醒，这个只要正常集成了第三方的SDK，并使用了他们对应的服务，当一个设备安装的多个应用都集成了某一个第三方SDK时，启动任意一个 app 都会唤醒其他的 app，不过这个在一些新版的国内厂商系统也是做了限制，这种方式并没有什么效果</li>
<li>一像素的 Activity 方式（流氓方式），经测试一些手机系统无法检测到解锁和锁屏，不确定是否系统修改了解锁或者锁屏的广播，还是禁用了这些广播，因此此方式无效；</li>
</ul>
</blockquote>
<h3 id="结语"><a href="#结语" class="headerlink" title="#结语"></a>#结语</h3><p>事事没有绝对，万物总有一些漏洞，就算上边的那些方式不可用了，后边肯定还会出现其他的方式；我们不能保证我们的应用不死，但我们可以提高存活率；</p>
<p>其实最好的方式还是把程序做好，让程序本身深入人心，别人喜欢你了，就算你被干掉了，他们也会主动的把你拉起来，然后把你加入他们的白名单，然后我们的目的就实现了不是 😁 ~</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="#参考资料"></a>#参考资料</h3><ul>
<li>【<a href="https://segmentfault.com/a/1190000006251859" target="_blank" rel="external">腾讯Bugly干货分享 Android 进程保活招式大全</a>】</li>
<li>【<a href="https://developer.android.com/guide/components/processes-and-threads.html" target="_blank" rel="external">Android 官方文档-进程和线程</a>】</li>
<li>【<a href="http://www.cnblogs.com/angeldevil/archive/2013/05/21/3090872.html" target="_blank" rel="external">Android Low Memory Killer</a>】</li>
<li>【<a href="http://www.jianshu.com/p/63aafe3c12af" target="_blank" rel="external">关于 Android 进程保活，你所需要知道的一切</a>】</li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/blog/tags/Android/" rel="tag"># Android</a>
          
            <a href="/blog/tags/Daemon/" rel="tag"># Daemon</a>
          
            <a href="/blog/tags/JobService/" rel="tag"># JobService</a>
          
            <a href="/blog/tags/JobScheduler/" rel="tag"># JobScheduler</a>
          
            <a href="/blog/tags/Process/" rel="tag"># Process</a>
          
            <a href="/blog/tags/Service/" rel="tag"># Service</a>
          
            <a href="/blog/tags/StartForeground/" rel="tag"># StartForeground</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2017/02/android-library-so-error-unsatisfiedlinkerror-1487659244.html" rel="next" title="使用第三方库出现找不到so库UnsatisfiedLinkError错误的原因以及解决方案">
                <i class="fa fa-chevron-left"></i> 使用第三方库出现找不到so库UnsatisfiedLinkError错误的原因以及解决方案
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2017/03/android-library-im-sdk-hyphenate-v3-1489749364000.html" rel="prev" title="关于环信3.xSDK日志简单分析">
                关于环信3.xSDK日志简单分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>

    <div>
      
        
  <div id="reward">
    <div reward_comment>
      <p>阿弥陀佛，施主，来个馒头吧 😋 ~</p>
    </div>
    <button id="reward_button" disable="enable" onclick="var qr = document.getElementById('reward_qr'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>~ 阿弥陀佛 ~</span>
    </button>
    <div id="reward_qr" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="http://lzan13.qiniudn.com/blog/upload/images/qr-wechat-2.jpg" alt="lzan13 WeChat Pay"/>
          <p>微信支持</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="http://lzan13.qiniudn.com/blog/upload/images/qr-alipay-2.jpg" alt="lzan13 Alipay"/>
          <p>支付宝支持</p>
        </div>
      
    </div>
  </div>


      
    </div>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_douban"></a>
	<a class="jiathis_button_ydnote"></a>
	<a class="jiathis_button_fav"></a>
	<a class="jiathis_button_copy"></a>
	<a class="jiathis_button_kaixin001"></a>
	<a class="jiathis_button_twitter"></a>
	<a class="jiathis_button_googleplus"></a>
	<a class="jiathis_button_renren"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/blog/images/avatar.png"
               alt="lzan13" />
          <p class="site-author-name" itemprop="name">lzan13</p>
          <p class="site-description motion-element" itemprop="description">❤️ 编程 ❤️ 动漫 ❤️ 折腾 ❤️ You  Android开发程序员，设计前端爱好者</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/blog/archives">
                <span class="site-state-item-count">79</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/blog/categories">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/blog/tags">
                <span class="site-state-item-count">146</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/blog/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/lzan13" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/lzan13" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/lzan13" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/lzan13" target="_blank" title="Zhihu">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Zhihu
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#进程的优先级"><span class="nav-number">1.</span> <span class="nav-text">#进程的优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#进程回收机制"><span class="nav-number">2.</span> <span class="nav-text">#进程回收机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#守护进程的实现"><span class="nav-number">3.</span> <span class="nav-text">#守护进程的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-模拟前台进程"><span class="nav-number">3.1.</span> <span class="nav-text">#1.模拟前台进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-JobScheduler机制唤醒"><span class="nav-number">3.2.</span> <span class="nav-text">#2.JobScheduler机制唤醒</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-系统-Service-START-STICKY-机制重启"><span class="nav-number">3.3.</span> <span class="nav-text">#3.系统 Service START_STICKY 机制重启</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-其他保活方式"><span class="nav-number">3.4.</span> <span class="nav-text">#4.其他保活方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结语"><span class="nav-number">4.</span> <span class="nav-text">#结语</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考资料"><span class="nav-number">5.</span> <span class="nav-text">#参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lzan13</span>
  <span class="beian">粤ICP备14080761号-1</span> 
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">iissnan.Next</a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/blog/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/blog/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  

  


</body>
</html>
